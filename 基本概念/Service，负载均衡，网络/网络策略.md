# 网络策略

- [前提](#前提)
- [隔离和非隔离的Pod](#隔离和非隔离的Pod)
- [NetworkPolicy](#NetworkPolicy)
- [`to`和`from`选择器](#to和from选择器)
- [默认策略](#默认策略)
  - [默认拒绝所有入口流量](#默认拒绝所有入口流量)
  - [默认允许所有入口流量](#默认允许所有入口流量)
  - [默认拒绝所有出口流量](#默认拒绝所有出口流量)
  - [默认允许所有出口流量](#默认允许所有出口流量)
  - [默认拒绝所有入口和出口流量](#默认拒绝所有入口和出口流量)
- [SCTP支持](#SCTP支持)
- [下一步……](#下一步)

网络策略是用来定义[Pod](../业务组件/泡德（Pod）/Pod.md)之间是否允许访问，以及是否能够访问其他网络端点的。

NetworkPolicy是通过[标签（label）](../概要/Kubernetes对象/标签（Label）和选择器（Selector）.md)来选定Pod，为它们定义流量限制规则。

## 前提

网络策略是由[网络插件](../计算，存储与网络拓展/网络插件.md)实现的。要想使用网络策略，那你的底层的网络方案就必须要支持NetworkPolicy。如果创建了一个NetworkPolicy资源，但是没有控制器来实现它，那也是没有什么卵用。

## 隔离和非隔离的Pod

默认情况下Pod都是非隔离的；它们可以通过任意资源进行相互访问。

当一个NetworkPolicy匹配了Pod，它就变成隔离的了。当任意一个NetworkPolicy选定了一个Pod，Pod会拒绝所有NetworkPolicy限制的流量。（其他没有被这个NetworkPolicy选中的Pod不受任何影响。）

网络策略不存在冲突的qingkuang；它们是累加的。如果某些策略都匹配了一个Pod，最终生效的策略是所有策略的并集。因此计算顺序并不影响最终策略的结构。

## NetworkPolicy

[NetworkPolicy](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#networkpolicy-v1-networking-k8s-io)的参考手册中有完整定义。

NetworkPolicy举例：

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: test-network-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      role: db
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - ipBlock:
        cidr: 172.17.0.0/16
        except:
        - 172.17.1.0/24
    - namespaceSelector:
        matchLabels:
          project: myproject
    - podSelector:
        matchLabels:
          role: frontend
    ports:
    - protocol: TCP
      port: 6379
  egress:
  - to:
    - ipBlock:
        cidr: 10.0.0.0/24
    ports:
    - protocol: TCP
      port: 5978
```

>**注意**：只有你的底层网络方案支持网络策略的前提下，把这个定义POST到api server才会生效。

**必填项**：跟其他k8s资源类型，NetworkPolicy需要`apiVersion`、`kind`和`metadata`字段。对于如何进行配置，见[用ConfigMap来配置容器](https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/)，以及[对象管理](../概要/Kubernetes对象/k8s对象管理.md)

## 下一步……