# 镜像

创建Docker镜像，推到仓库里，用在Pod中，就这么个事儿。

容器的`image`属性跟`docker`命令中的写法一样，包括私有仓库地址和tag。

- [更新镜像](#更新镜像)
- [用Manifest构建多架构镜像](#用Manifest构建多架构镜像)
- [使用私有仓库](#使用私有仓库)

## 更新镜像

默认的镜像拉取策略是`IfNotPresent`，如果镜像存在，kubelet就不拉了。如果你想每次必拉，需要服用以下泻药：

- `imagePullPolicy`设置为`Always`。
- 不写`imagePullPolicy`，镜像tag使用`:latest`。
- `imagePullPolicy`和镜像tag都不写。
- 为Admission控制器开启[必拉]()，让你百分百被空手接白刃。

注意，尽量别用`:latest`tag，见[最佳实践]()。

## 用Manifest构建多架构镜像

Docker命令行现在支持`docker manifest`命令，包含`create`、`annotate`和`push`等子命令。这些命令可以用来创建和推送manifest。可以用`docker manifest inspect`来查看manifest详情。

看看这里的docker文档：https://docs.docker.com/edge/engine/reference/commandline/manifest/

看看我们自己是咋用的：https://cs.k8s.io/?q=docker%20manifest%20(create%7Cpush%7Cannotate)&i=nope&files=&repos=
           
这些命令都是Docker的。不过这玩意还处于试验阶段，可以编辑`$HOME/.docker/config.json`文件，将`experimental`设置为`enabled`，或者直接将环境变量`DOCKER_CLI_EXPERIMENTAL`设置为`enabled`来启用这些命令。

>**注意**：你得用Docker *18.06或更高*的版本，再往前的版本要么有bug，要么不支持开启试验属性。比如https://github.com/docker/cli/issues/1135这里的问题就会在containerd环境下报错。

如果你上传一些旧的manifest时出错了，可以清理`$HOME/.docker/manifest`目录。

对于k8s来说，我们用的镜像都有`-$(ARCH)`后缀。为了向后兼容，旧的镜像都要加上这种后缀。比如`pause`镜像，它就有支持多架构的manifest，而`pause-amd64`则为旧的配置或在YAML硬编码了镜像后缀的情况提供向后兼容性。

## 使用私有仓库

使用私有仓库时可能需要密钥。有多种方式提供凭证信息：

- 使用Google Container Registry

[^_^]: TODO

- 使用Amazon Elastic Container Registry(ECR)

[^_^]: TODO

- 使用Oracle Cloud Infrastructure Registry(OCIR)

[^_^]: TODO