# k8s对象管理
命令行工具`kubectl`提供了一大堆的方法来创建、管理k8s对象。本文就来简单介绍一下这些方法。具体细节你们去[Kubectl小百科]()里面找去。

- [管理方法](#管理方法)
- [命令式命令](#命令式命令)（呵呵？）
- [命令式对象配置](#命令式对象配置)
- [声明式对象配置](#声明式对象配置)
- [接下来……](#接下来)

## 管理方法

>**警告**：一个k8s对象一定要选择一个固定的方法来管理。多种方法一起用的话，容易紊乱。

管理方法|目标|建议的环境|支持几个人操作|学习曲线
-|-|-|-|-
命令式命令|当前对象|开发环境|1+|最低
命令式对象配置|单个文件|生产环境|1|平缓
声明式对象配置|文件夹|生产环境|1+|陡峭

## 命令式命令

使用这种方法的时候，用户直接操作当前对象。用户将各种操作设置成`kubectl`的参数或选项。

如果你是初出茅庐或者想运行一个一次性的任务，这种方式最简单。因为这种方式直接操作当前对象，无法提供历史痕迹。

### 例子

创建Deployment对象来运行一个nginx容器：

```text
kubectl run nginx --image nginx
```

另一种相同效果的语法：

```text
kubectl create deployment nginx --image nginx
```

### 优缺点

和对象配置相比，优点如下：

- 命令本身很简单，学起来也容易，不容易忘。
- 一步就完事儿。

缺点如下：

- 无法结合变更审查。
- 没有审计跟踪。
- 除了能看到当前都有啥，没有历史记录。（杠精请尝试`history`命令）
- 没有模板。

## 命令式对象配置

使用这种方法的时候，kubectl命令只声明操作类型（创建、替换等），加上一些可选的选项，然后必须至少指定一个文件名。这个文件中必须要用YAML或JSON格式给出完整的对象定义。

关于对象定义可以看[API文档]()。

>**警告**：命令式的`replace`命令直接用新的声明替换当前已经存在的声明，当前文件中没有的信息，直接就都删了。这种方式不应该用在那些除了配置文件之外还有其他途径去修改声明的资源类型上。比如`LoadBalancer`服务，它的`externalIPs`属性是集群来更新的。

### 例子

用配置文件创建对象：

```text
kubectl create -f nginx.yaml
```

删除两个文件中定义的对象：
```text
kubectl delete -f nginx.yaml -f redis.yaml
```

用新的配置更新当前对象的定义：
```text
kubectl replace -f nginx.yaml
```

### 优缺点

和命令式命令相比，优点如下：

- 配置文件可以用GIT管理。
- 推送之前可以增加审查、审计跟踪流程。
- 有模板可用。

缺点如下：

- 需要了解对象的schema。
- 需要写YAML文件。

和声明式对象配置相比，优点如下：

- 更简单，更好理解。
- 从1.5版本开始，命令式对象配置这种方法变得更加成熟了。

缺点如下：

- 不能很好的利用文件夹。
- 对当前对象的更新要反映在配置文件中，否则下次替换的时候就找不到了。

## 声明式对象配置

使用这种方法的时候，用户操作本地的对象配置文件，但是不用定义要做什么操作。是创建、更新、还是删除，由`kubectl`为每个对象自动识别。这种方式就可以利用文件夹了，对于里面的每个对象，会识别出不同的操作。

>**注意**：这种方法会保留其他人所作的修改，即便这种修改还没有合并到配置文件中。比如用`patch`API写入一些能看出来的修改，而不是用`replace`API替换整个对象配置。（难理解吗？好像明白点儿，又好像不太明白）

### 例子

处理所有`configs`目录下的对象配置文件，创建新的对象，或者给当前对象打些补丁。可以先用`diff`命令看一看可能会发生哪些操作，然后再去真正运行：

```text
kubectl diff -f configs/
kubectl apply -f configs/
```

递归处理：

```text
kubectl diff -R -f configs/
kubectl apply -R -f configs/
```

### 优缺点

和命令式对象配置相比，有以下优点：

- 对当前对象直接进行的操作可以保留，即便没有合并到配置文件中。
- 可以更好的支持文件夹操作，自动识别每个对象的操作类型（创建，打补丁，删除）。

缺点如下：

- 出问题的时候不好调试，不好理解。
- 根据差异所进行的更新，会产生复杂的合并、补丁操作。

## 接下来……

- [用命令式命令管理k8s对象]()
- [用对象配置管理k8s对象（命令式）]()
- [用对象配置管理k8s对象（声明式）]()
- [用Kustomize管理k8s对象（声明式）]()
- [kubectl命令手册]()
- [kubectl小百科]()
- [Kubernetes API文档]()