# 设备插件

**功能状态**：`Kubernetes v1.10 [beta]`

k8s提供了一个[设备插件框架](https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/device-plugin.md)，你可以用它把系统硬件资源发布到[Kubelet](https://v1-18.docs.kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)。

不需要去对k8s本身的代码进行定制，供应商只需要实现一个设备插件，然后进行手动部署，或者通过[DaemonSet](../../业务组件/控制器/DaemonSet.md)部署即可。目标设备包括GPU、高性能NIC、FPGA、InfiniBand适配器以及其他类似的，需要供应商特定初始化和安装操作的计算资源。

## 设备插件注册

kubelet暴露了一个`Registration`gRPC服务：

```go
service Registration {
	rpc Register(RegisterRequest) returns (Empty) {}
}
```

设备插件可以通过这个gRPC服务将自身注册到kubelet上。在注册时，设备插件需要发送：

- 它的Unix socket名字。
- 构建的设备插件API版本。
- 它要发布的`ResourceName`。这里的`ResourceName`需要遵守[扩展资源命名scheme](../../配置/管理容器资源.md#扩展资源)，格式为`vendor-domain/resourcetype`。（比如一个NVDIA GPU就要发布成`nvidia.com/gpu`。）

注册成功后，设备插件要将其管理的设备列表发送给kubelet，然后kubelet要负责将这些资源发布到apiserver上，使其作为节点status更新的一部分。比如一个设备插件在kubelet上注册了`hardware-vendor.example/foo`，然后上报了某个节点上的两个健康状态的设备，那么节点的status就会更新，显示该节点安装了2个“Foo”设备，并且已经可以用了。

在这之后，用户可以像请求其他类型的资源一样，在[容器](https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#container-v1-core)定义中请求这些设备，但是有以下限制：

- 扩展资源只能作为整数计数的资源，而且不能过量使用。
- 容器间无法共享设备。

假设某个k8s集群上运行了一个设备插件，其在某个节点上发布了`hardware-vendor.example/foo`资源。下面的栗子就是一个Pod请求该资源来运行一个demo：

```yaml
---
apiVersion: v1
kind: Pod
metadata:
  name: demo-pod
spec:
  containers:
    - name: demo-container-1
      image: k8s.gcr.io/pause:2.0
      resources:
        limits:
          hardware-vendor.example/foo: 2
#
# This Pod needs 2 of the hardware-vendor.example/foo devices
# and can only schedule onto a Node that's able to satisfy
# that need.
#
# If the Node has more than 2 of those devices available, the
# remainder would be available for other Pods to use.
```

## 实现设备插件

